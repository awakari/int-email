apiVersion: batch/v1
kind: CronJob
metadata:
  name: "{{ include "int-email.fullname" . }}-secrets-backup"
spec:
  schedule: "{{ .Values.backup.secrets.schedule }}"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: "{{ include "int-email.fullname" . }}-secrets-backup"
              image: "{{ .Values.backup.secrets.image }}"
              env:
                {{- if .Values.ingress.tls }}
                {{- range .Values.ingress.tls }}
                - name: SECRET_TLS_CRT
                  valueFrom:
                    secretKeyRef:
                      name: "{{ .secretName }}"
                      key: "tls.crt"
                - name: SECRET_TLS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: "{{ .secretName }}"
                      key: "tls.key"
                {{- end}}
                {{- end}}
              volumeMounts:
                - name: "{{ .Values.backup.secrets.volume.name }}"
                  mountPath: /var/backup
                  readOnly: false
              command:
                - "/bin/sh"
                - "-c"
                - |
                  mkdir -p /var/backup/{{ include "int-email.fullname" . }}
                  if [ -n "$SECRET_TLS_CRT" ]; then  # Check if secret is not empty
                    echo "Original secret tls.crt is not empty. Creating backup..."
                    echo "$SECRET_TLS_CRT" > /var/backup/{{ include "int-email.fullname" . }}/tls.crt
                  else
                    echo "Original secret tls.crt is empty. Skipping backup."
                  fi
                  if [ -n "$SECRET_TLS_KEY" ]; then  # Check if secret is not empty
                    echo "Original secret tls.key is not empty. Creating backup..."
                    echo "$SECRET_TLS_KEY" > /var/backup/{{ include "int-email.fullname" . }}/tls.key
                  else
                    echo "Original secret tls.key is empty. Skipping backup."
                  fi
          restartPolicy: OnFailure
          volumes:
            - name: "{{ .Values.backup.secrets.volume.name }}"
              persistentVolumeClaim:
                claimName: "{{ .Values.backup.secrets.volume.name }}"
